<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant de Composition</title>
    <style>
        :root {
            --bg-dark: #121212;
            --bg-light: #1e1e1e;
            --text: #e0e0e0;
            --primary: #00bcd4;
            --primary-dark: #0097a7;
            --error: #d32f2f;
            --success: #388e3c;
            --border: #444;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }
        .sticky-banner {
            position: sticky;
            top: 0;
            background-color: var(--bg-light);
            padding: 10px 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        button {
            background-color: var(--bg-light);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }
        button:hover:not(:disabled) {
            background-color: var(--primary-dark);
            color: white;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        button.loading {
            position: relative;
            color: transparent;
        }
        button.loading::after {
            content: "";
            position: absolute;
            width: 1em;
            height: 1em;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
            border: 0.125em solid transparent;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s ease infinite;
        }
        button.done {
            background-color: var(--success);
            color: white;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .section {
            background-color: var(--bg-light);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        .section-title {
            color: var(--primary);
            border-bottom: 1px solid var(--border);
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        textarea, input {
            width: 100%;
            background-color: var(--bg-dark);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 0.5em;
            resize: vertical;
            height: 1.1em;
            overflow-y: hidden;
        }
        .array-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: flex-start;
        }
        .array-item textarea {
            flex: 1;
        }
        .array-controls {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .array-controls button {
            padding: 5px 10px;
            font-size: 0.8em;
        }
        .remove-btn {
            background-color: var(--error);
            color: white;
            padding: 0 8px;
            height: fit-content;
        }
        .remove-btn:hover {
            background-color: #b71c1c;
        }
        .debug {
            background-color: var(--bg-dark);
            padding: 15px;
            border-radius: 8px;
            margin-top: 30px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .debug-title {
            color: var(--primary);
            margin-bottom: 10px;
        }
        .prompt-section {
            margin-top: 30px;
        }
        .prompt-section textarea {
            font-family: monospace;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="sticky-banner">
        <button id="importBtn" title="Importer JSON">I</button>
        <button id="exportBtn" title="Exporter JSON">E</button>
        <button id="step1Btn" disabled>1. Cadrage du sujet</button>
        <button id="step2Btn" disabled>2. R√©flexion</button>
        <button id="step3Btn" disabled>3. Planification</button>
        <button id="step4Btn" disabled>4. R√©daction</button>
        <button id="magicBtn" title="Lancer toutes les √©tapes" disabled>ü™Ñ</button>
    </div>
    <div class="container">
        <div class="section">
            <div class="section-title">Sujet</div>
            <textarea id="sujet" placeholder="Entrez le sujet ici..."></textarea>
        </div>
        <div class="section">
            <div class="section-title">Sujet cadr√©</div>
            <textarea id="sujetCadre" placeholder="Le sujet cadr√© appara√Ætra ici..."></textarea>
        </div>
        <div class="section">
            <div class="section-title">R√©flexions</div>
            <div class="subsection">
                <div>Faits</div>
                <div id="faitsContainer"></div>
                <button id="addFaitBtn" class="hidden">+ Ajouter un fait</button>
            </div>
            <div class="subsection">
                <div>Probl√©matiques</div>
                <div id="problematiquesContainer"></div>
                <button id="addProblematiqueBtn" class="hidden">+ Ajouter une probl√©matique</button>
            </div>
            <div class="subsection">
                <div>Id√©es</div>
                <div id="ideesContainer"></div>
                <button id="addIdeeBtn" class="hidden">+ Ajouter une id√©e</button>
            </div>
        </div>
        <div class="section">
            <div class="section-title">Plan</div>
            <div>
                <div>Accroche</div>
                <textarea id="accroche" placeholder="L'accroche appara√Ætra ici..."></textarea>
            </div>
            <div>
                <div>Id√©e ma√Ætresse</div>
                <textarea id="ideeMaitresse" placeholder="L'id√©e ma√Ætresse appara√Ætra ici..."></textarea>
            </div>
            <div>
                <div>Id√©es directrices</div>
                <div id="ideesDirectricesContainer"></div>
                <button id="addIdeeDirectriceBtn" class="hidden">+ Ajouter une id√©e directrice</button>
            </div>
            <div>
                <div>Ouverture</div>
                <textarea id="ouverture" placeholder="L'ouverture appara√Ætra ici..."></textarea>
            </div>
        </div>
        <div class="section">
            <div class="section-title">Composition</div>
            <textarea id="composition" placeholder="La composition appara√Ætra ici..."></textarea>
        </div>
        <div class="prompt-section section">
            <div class="section-title">Prompts</div>
            <div>
                <div>D√©but de prompt pour compl√©ter le JSON</div>
                <textarea id="basePrompt" readonly>Vous assistez un r√©dacteur dans la cr√©ation d‚Äôune composition en 4 √©tapes. Votre mission est de compl√©ter une seule propri√©t√© de premier niveau du JSON fourni, sans modifier les autres.
Les 5 top-level properties du JSON sont : sujet, sujet cadr√©, r√©flexions, plan, composition.
Les 4 √©tapes sont : cadrage du sujet, r√©flexion, planification, r√©daction.
Consignes absolues :
    Conservez la structure JSON existante dans son int√©gralit√© (cl√©s, valeurs, ordre).
    Ne compl√©tez que la propri√©t√© de premier niveau li√©e √† l‚Äô√©tape demand√©e.
Format strict :
    Pas de mise en forme dans le texte g√©n√©r√© (pas de Markdown, pas de sauts de ligne inutiles).
    Respectez les types de donn√©es existants (string, array, object).
    Ne supprimez ni ne modifiez les autres propri√©t√©s.</textarea>
            </div>
            <div>
                <div>Continuation du prompt pour l'√©tape 1</div>
                <textarea id="step1Prompt" readonly>Etape 1 : Cadrage du sujet
Input : sujet
Output : sujet cadr√©
Objectif :
L'objectif est de reformuler le sujet en ayant bien identifi√© de quoi il s'agit et de comprendre le cadre applicable qui peut √™tre sous-entendu. Le sujet cadr√© doit :
- pr√©ciser le domaine et le cadre g√©n√©ral ;
- reformuler afin de clarifier le sens des mots si plusieurs interpr√©tations sont possibles (lever l'ambigu√Øt√© des termes polys√©miques) ;
- d√©finir les limites g√©ographiques, temporelles, et th√©matiques.
Contraintes : Conserver la structure syntaxique du sujet original (interrogative ou affirmative).
Eviter tout d√©tour √©nonciatif.
Longueur d'une phrase ou deux.
Format : Respecter strictement le format JSON pour la propri√©t√© "sujet cadr√©" (texte brut).</textarea>
            </div>
            <div>
                <div>Continuation du prompt pour l'√©tape 2</div>
                <textarea id="step2Prompt" readonly>Etape 2 : R√©flexion
Input : sujet, sujet cadr√©
Output : r√©flexions
Objectif : L'√©tape de r√©flexion a pour but de lister des faits, des probl√©matiques et des id√©es en lien avec le sujet.
Les faits ne doivent refl√©ter que la r√©alit√© et ne pas int√©grer de biais ou de parti pris. Ils doivent √™tre dat√©s, localis√©s et chiffr√©s dans la mesure du possible. Des citations c√©l√®bres peuvent √™tre ins√©r√©es dans cette liste. La r√©daction √©tant en fran√ßais, la r√©partition entre faits fran√ßais et √©tranger doit √™tre approximativement de 50 %. Les exemples √©trangers doivent balayer une large part du reste du monde, sans exclure aucune grande r√©gion ou grande √©poque de l'Histoire. La liste de faits doit comprendre au moins 20 √©l√©ments.
Les probl√©matiques permettent par les questions pos√©es d'√©largir le champ de r√©flexion en questionnant chaque aspect du sujet, en variant le lieu ou l'√©poque, l'angle sous lequel il est abord√©, en questionnant les int√©r√™ts des autres acteurs, les causes et les cons√©quences des faits, et en mettant en lumi√®re les enjeux. La liste de probl√©matiques doit comprendre au moins 12 √©l√©ments.
Les id√©es √©l√©mentaires permettent de proposer des id√©es li√©es au sujet dont l'ampleur va de l'id√©e secondaire √† l'id√©e ma√Ætresse. La certitude des id√©es doit pouvoir aller de l'affirmation √©tablie aux hypoth√®ses cr√©dibles (d√©battue mais √©tay√©es), mais sans jamais aller du c√¥t√© des affirmations ind√©montrables ou des avis purement personnels. Il faut inclure des id√©es cr√©atives ou originales. Il n'y a pas de contrainte sur la coh√©rence globale entre les id√©es, tant que chaque id√©e est individuellement argumentable.
La liste d'id√©es √©l√©mentaires doit comprendre au moins 20 √©l√©ments.
Format : Suivre strictement le format JSON de la top-level property r√©flexions compos√© de trois arrays de texte.</textarea>
            </div>
            <div>
                <div>Continuation du prompt pour l'√©tape 3</div>
                <textarea id="step3Prompt" readonly>Etape 3 : Planification
Input : sujet, sujet cadr√©, r√©flexions
Output : plan
Objectif : L'√©tape de planification, ou de r√©alisation du plan d√©taill√© doit permettre de hi√©rarchiser les id√©es pour en d√©gager une id√©e ma√Ætresse qui sera appuy√©e par des id√©es directrices, elles-m√™mes soutenues par des id√©es secondaires qui seront illustr√©es par des exemples. C'est aussi l'occasion de choisir une accroche et une ouverture. Le cheminement des id√©es doit √™tre logique. Le plan est compos√© de plusieurs parties, entre 2 et 4, chacune soutenant une id√©e directrice. Chaque partie est d√©compos√©e en plusieurs id√©es secondaires, de 2 √† 4 id√©es secondaires. Chaque id√©e secondaire est illustr√©e par au moins un exemple.
L'accroche doit √©veiller la curiosit√© en s'appuyant sur un fait saillant ou une citation en lien avec l'id√©e ma√Ætresse.
L'ouverture doit permettre de s'interroger sur un autre aspect connexe, non trait√© dans le d√©veloppement, sans repartir sur un nouveau sujet.
Contraintes :
Ordonner les id√©es selon une progression logique (chronologique, th√©matique, causale, etc.) pour assurer fluidit√© et transitions naturelles.
Equilibrer entre les parties. Chaque partie est s√©mantiquement orthogonale aux autres sur au moins un aspect majeur tout en restant coh√©rente avec l'id√©e ma√Ætresse.
Ne pas num√©roter les id√©es.
Un exemple par id√©e secondaire.
Reprendre au moins la moiti√© des id√©es et la moiti√© des exemples formul√©es dans r√©flexions.
Format : Suivre strictement le format JSON de la top-level property plan.</textarea>
            </div>
            <div>
                <div>Continuation du prompt pour l'√©tape 4</div>
                <textarea id="step4Prompt" readonly>Etape 4 : R√©daction
Input : sujet, sujet cadr√©, r√©flexions, plan
Output : composition
Objectif : R√©diger la composition.
La structure de la composition, tel que l'introduction, le d√©veloppement et ses parties, et la conclusion transparait gr√¢ce aux paragraphes et aux retours √† la ligne.
L'introduction comprend une accroche, le sujet reformul√©, l'id√©e ma√Ætresse, et l'annonce du plan. L'introduction forme un paragraphe.
Le d√©veloppement comprend 2 √† 4 parties, autant que d'id√©es directrices. Chaque partie commence par l'√©nonc√© de l'id√©e directrice, un d√©veloppement de partie et une transition. Le d√©veloppement de partie comprend 2 √† 4 id√©es secondaires √©tay√©es par leur exemple. Le d√©veloppement comprend plusieurs paragraphes, autant que de partie. Dans le paragraphe que forme chaque partie, un retour √† la ligne permet de marquer le d√©but de chaque id√©e secondaire.
La conclusion comprend un r√©sum√© de l'argumentation, la r√©ponse √† la question pos√©e ou un r√©sum√© de l'id√©e ma√Ætresse et une ouverture. La conclusion forme un paragraphe.
Contraintes :
Le style doit √™tre clair et √©pur√©. Le vocabulaire doit √™tre riche et utilis√© pr√©cis√©ment. La complexit√© syntaxique ne doit servir que pour mieux exprimer des id√©es complexes.
Format : Suivre strictement le format JSON de la top-level property composition qui est un simple texte. La forme de la composition n'est donc que du texte. La composition fait 1000 mots. Les sauts de ligne doivent √™tre √©chapp√©s (\n).</textarea>
            </div>
        </div>
        <div class="debug section">
            <div class="debug-title">Dernier message envoy√© :</div>
            <div id="lastSent" class="debug-content"></div>
            <div class="debug-title">Dernier message re√ßu :</div>
            <div id="lastReceived" class="debug-content"></div>
        </div>
    </div>
    <script>
        // Structure de donn√©es initiale
        let compositionData = {
            "sujet": "",
            "sujet cadr√©": "",
            "r√©flexions": {
                "faits": [""],
                "probl√©matiques": [""],
                "id√©es": [""]
            },
            "plan": {
                "accroche": "",
                "id√©e ma√Ætresse": "",
                "id√©es directrices": [
                    {
                        "ID": "",
                        "id√©es secondaires": [
                            { "IS": "", "exemple": "" }
                        ]
                    }
                ],
                "ouverture": ""
            },
            "composition": ""
        };
        // √âtats des boutons
        const buttonStates = {
            NOT_AVAILABLE: 0,
            READY: 1,
            LOADING: 2,
            DONE: 3
        };
        // DOM Elements
        const sujetInput = document.getElementById('sujet');
        const sujetCadreInput = document.getElementById('sujetCadre');
        const accrocheInput = document.getElementById('accroche');
        const ideeMaitresseInput = document.getElementById('ideeMaitresse');
        const ouvertureInput = document.getElementById('ouverture');
        const compositionInput = document.getElementById('composition');
        const factsContainer = document.getElementById('faitsContainer');
        const problematiquesContainer = document.getElementById('problematiquesContainer');
        const ideesContainer = document.getElementById('ideesContainer');
        const ideesDirectricesContainer = document.getElementById('ideesDirectricesContainer');
        const addFaitBtn = document.getElementById('addFaitBtn');
        const addProblematiqueBtn = document.getElementById('addProblematiqueBtn');
        const addIdeeBtn = document.getElementById('addIdeeBtn');
        const addIdeeDirectriceBtn = document.getElementById('addIdeeDirectriceBtn');
        const importBtn = document.getElementById('importBtn');
        const exportBtn = document.getElementById('exportBtn');
        const step1Btn = document.getElementById('step1Btn');
        const step2Btn = document.getElementById('step2Btn');
        const step3Btn = document.getElementById('step3Btn');
        const step4Btn = document.getElementById('step4Btn');
        const magicBtn = document.getElementById('magicBtn');
        const lastSentDiv = document.getElementById('lastSent');
        const lastReceivedDiv = document.getElementById('lastReceived');
        const basePrompt = document.getElementById('basePrompt');
        const step1Prompt = document.getElementById('step1Prompt');
        const step2Prompt = document.getElementById('step2Prompt');
        const step3Prompt = document.getElementById('step3Prompt');
        const step4Prompt = document.getElementById('step4Prompt');

        // Fonction pour ajuster la hauteur des textarea
        function autoResize(textarea) {
            textarea.style.height = '1.1em';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }

        // Initialisation
        function init() {
            renderFaits();
            renderProblematiques();
            renderIdees();
            renderIdeesDirectrices();
            updateButtonStates();
            setupEventListeners();
            // Appliquer autoResize √† tous les textarea existants
            document.querySelectorAll('textarea').forEach(textarea => {
                autoResize(textarea);
            });
        }

        // Rendu des sections dynamiques
        function renderFaits() {
            factsContainer.innerHTML = '';
            compositionData.r√©flexions.faits.forEach((fait, index) => {
                const div = document.createElement('div');
                div.className = 'array-item';
                div.innerHTML = `
                    <textarea placeholder="Fait ${index + 1}">${fait}</textarea>
                    <button class="remove-btn" data-index="${index}">√ó</button>
                `;
                factsContainer.appendChild(div);
                const textarea = div.querySelector('textarea');
                autoResize(textarea);
                textarea.addEventListener('input', () => autoResize(textarea));
            });
            addFaitBtn.classList.toggle('hidden', compositionData.r√©flexions.faits.length === 0);
        }

        function renderProblematiques() {
            problematiquesContainer.innerHTML = '';
            compositionData.r√©flexions.probl√©matiques.forEach((pb, index) => {
                const div = document.createElement('div');
                div.className = 'array-item';
                div.innerHTML = `
                    <textarea placeholder="Probl√©matique ${index + 1}">${pb}</textarea>
                    <button class="remove-btn" data-index="${index}">√ó</button>
                `;
                problematiquesContainer.appendChild(div);
                const textarea = div.querySelector('textarea');
                autoResize(textarea);
                textarea.addEventListener('input', () => autoResize(textarea));
            });
            addProblematiqueBtn.classList.toggle('hidden', compositionData.r√©flexions.probl√©matiques.length === 0);
        }

        function renderIdees() {
            ideesContainer.innerHTML = '';
            compositionData.r√©flexions.id√©es.forEach((idee, index) => {
                const div = document.createElement('div');
                div.className = 'array-item';
                div.innerHTML = `
                    <textarea placeholder="Id√©e ${index + 1}">${idee}</textarea>
                    <button class="remove-btn" data-index="${index}">√ó</button>
                `;
                ideesContainer.appendChild(div);
                const textarea = div.querySelector('textarea');
                autoResize(textarea);
                textarea.addEventListener('input', () => autoResize(textarea));
            });
            addIdeeBtn.classList.toggle('hidden', compositionData.r√©flexions.id√©es.length === 0);
        }

        function renderIdeesDirectrices() {
            ideesDirectricesContainer.innerHTML = '';
            compositionData.plan['id√©es directrices'].forEach((id, idIndex) => {
                const idDiv = document.createElement('div');
                idDiv.className = 'section';
                idDiv.style.marginBottom = '15px';
                idDiv.innerHTML = `
                    <div>Id√©e directrice ${idIndex + 1}</div>
                    <textarea placeholder="Id√©e directrice">${id.ID}</textarea>
                    <div style="margin-top: 10px;">
                        <div>Id√©es secondaires</div>
                        <div id="ideesSecondaires-${idIndex}"></div>
                        <button class="add-is-btn" data-id-index="${idIndex}">+ Ajouter une id√©e secondaire</button>
                    </div>
                    <button class="remove-btn" data-id-index="${idIndex}" style="margin-top: 10px;">√ó Supprimer cette id√©e directrice</button>
                `;
                ideesDirectricesContainer.appendChild(idDiv);
                const idTextarea = idDiv.querySelector('textarea');
                autoResize(idTextarea);
                idTextarea.addEventListener('input', () => autoResize(idTextarea));

                const isContainer = idDiv.querySelector(`#ideesSecondaires-${idIndex}`);
                id['id√©es secondaires'].forEach((is, isIndex) => {
                    const isDiv = document.createElement('div');
                    isDiv.className = 'array-item';
                    isDiv.style.marginTop = '5px';
                    isDiv.innerHTML = `
                        <div style="flex: 1;">
                            <textarea placeholder="Id√©e secondaire ${isIndex + 1}">${is.IS}</textarea>
                            <textarea placeholder="Exemple ${isIndex + 1}" style="margin-top: 5px;">${is.exemple}</textarea>
                        </div>
                        <button class="remove-is-btn" data-id-index="${idIndex}" data-is-index="${isIndex}">√ó</button>
                    `;
                    isContainer.appendChild(isDiv);
                    const isTextareas = isDiv.querySelectorAll('textarea');
                    isTextareas.forEach(textarea => {
                        autoResize(textarea);
                        textarea.addEventListener('input', () => autoResize(textarea));
                    });
                });
            });
            addIdeeDirectriceBtn.classList.toggle('hidden', compositionData.plan['id√©es directrices'].length === 0);
        }

        // Gestion des √©tats des boutons
        function updateButtonStates() {
            const hasSujet = compositionData.sujet.trim() !== '';
            const hasSujetCadre = compositionData['sujet cadr√©'].trim() !== '';
            const hasReflexions = compositionData.r√©flexions.faits.some(f => f.trim() !== '') ||
                                 compositionData.r√©flexions.probl√©matiques.some(p => p.trim() !== '') ||
                                 compositionData.r√©flexions.id√©es.some(i => i.trim() !== '');
            const hasPlan = compositionData.plan.accroche.trim() !== '' ||
                           compositionData.plan['id√©e ma√Ætresse'].trim() !== '' ||
                           compositionData.plan['id√©es directrices'].some(id => id.ID.trim() !== '');
            // √âtape 1
            step1Btn.disabled = !hasSujet;
            step1Btn.classList.remove('done');
            step1Btn.classList.remove('loading');
            // √âtape 2
            step2Btn.disabled = !hasSujetCadre;
            step2Btn.classList.remove('done');
            step2Btn.classList.remove('loading');
            // √âtape 3
            step3Btn.disabled = !hasReflexions;
            step3Btn.classList.remove('done');
            step3Btn.classList.remove('loading');
            // √âtape 4
            step4Btn.disabled = !hasPlan;
            step4Btn.classList.remove('done');
            step4Btn.classList.remove('loading');
            // Bouton magique
            magicBtn.disabled = !hasSujet;
        }

        // √âv√©nements
        function setupEventListeners() {
            // Champs texte
            sujetInput.addEventListener('input', (e) => {
                compositionData.sujet = e.target.value;
                autoResize(e.target);
                updateButtonStates();
            });
            sujetCadreInput.addEventListener('input', (e) => {
                compositionData['sujet cadr√©'] = e.target.value;
                autoResize(e.target);
                updateButtonStates();
            });
            accrocheInput.addEventListener('input', (e) => {
                compositionData.plan.accroche = e.target.value;
                autoResize(e.target);
                updateButtonStates();
            });
            ideeMaitresseInput.addEventListener('input', (e) => {
                compositionData.plan['id√©e ma√Ætresse'] = e.target.value;
                autoResize(e.target);
                updateButtonStates();
            });
            ouvertureInput.addEventListener('input', (e) => {
                compositionData.plan.ouverture = e.target.value;
                autoResize(e.target);
                updateButtonStates();
            });
            compositionInput.addEventListener('input', (e) => {
                compositionData.composition = e.target.value;
                autoResize(e.target);
            });

            // Ajout/suppression de faits
            addFaitBtn.addEventListener('click', () => {
                compositionData.r√©flexions.faits.push("");
                renderFaits();
            });
            factsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-btn')) {
                    const index = parseInt(e.target.getAttribute('data-index'));
                    compositionData.r√©flexions.faits.splice(index, 1);
                    renderFaits();
                }
            });
            factsContainer.addEventListener('input', (e) => {
                if (e.target.tagName === 'TEXTAREA') {
                    const index = Array.from(factsContainer.children).indexOf(e.target.parentElement);
                    compositionData.r√©flexions.faits[index] = e.target.value;
                }
            });

            // Ajout/suppression de probl√©matiques
            addProblematiqueBtn.addEventListener('click', () => {
                compositionData.r√©flexions.probl√©matiques.push("");
                renderProblematiques();
            });
            problematiquesContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-btn')) {
                    const index = parseInt(e.target.getAttribute('data-index'));
                    compositionData.r√©flexions.probl√©matiques.splice(index, 1);
                    renderProblematiques();
                }
            });
            problematiquesContainer.addEventListener('input', (e) => {
                if (e.target.tagName === 'TEXTAREA') {
                    const index = Array.from(problematiquesContainer.children).indexOf(e.target.parentElement);
                    compositionData.r√©flexions.probl√©matiques[index] = e.target.value;
                }
            });

            // Ajout/suppression d'id√©es
            addIdeeBtn.addEventListener('click', () => {
                compositionData.r√©flexions.id√©es.push("");
                renderIdees();
            });
            ideesContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-btn')) {
                    const index = parseInt(e.target.getAttribute('data-index'));
                    compositionData.r√©flexions.id√©es.splice(index, 1);
                    renderIdees();
                }
            });
            ideesContainer.addEventListener('input', (e) => {
                if (e.target.tagName === 'TEXTAREA') {
                    const index = Array.from(ideesContainer.children).indexOf(e.target.parentElement);
                    compositionData.r√©flexions.id√©es[index] = e.target.value;
                }
            });

            // Ajout/suppression d'id√©es directrices
            addIdeeDirectriceBtn.addEventListener('click', () => {
                compositionData.plan['id√©es directrices'].push({
                    "ID": "",
                    "id√©es secondaires": [{ "IS": "", "exemple": "" }]
                });
                renderIdeesDirectrices();
                updateButtonStates();
            });
            ideesDirectricesContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-btn')) {
                    const idIndex = parseInt(e.target.getAttribute('data-id-index'));
                    compositionData.plan['id√©es directrices'].splice(idIndex, 1);
                    renderIdeesDirectrices();
                    updateButtonStates();
                } else if (e.target.classList.contains('add-is-btn')) {
                    const idIndex = parseInt(e.target.getAttribute('data-id-index'));
                    compositionData.plan['id√©es directrices'][idIndex]['id√©es secondaires'].push({ "IS": "", "exemple": "" });
                    renderIdeesDirectrices();
                } else if (e.target.classList.contains('remove-is-btn')) {
                    const idIndex = parseInt(e.target.getAttribute('data-id-index'));
                    const isIndex = parseInt(e.target.getAttribute('data-is-index'));
                    compositionData.plan['id√©es directrices'][idIndex]['id√©es secondaires'].splice(isIndex, 1);
                    renderIdeesDirectrices();
                }
            });
            ideesDirectricesContainer.addEventListener('input', (e) => {
                if (e.target.tagName === 'TEXTAREA') {
                    const idDiv = e.target.closest('.section');
                    const idIndex = Array.from(ideesDirectricesContainer.children).indexOf(idDiv);
                    const isDiv = e.target.closest('.array-item');
                    if (isDiv) {
                        const isIndex = Array.from(idDiv.querySelectorAll('.array-item')).indexOf(isDiv);
                        const textareaIndex = Array.from(isDiv.querySelectorAll('textarea')).indexOf(e.target);
                        if (textareaIndex === 0) {
                            compositionData.plan['id√©es directrices'][idIndex]['id√©es secondaires'][isIndex].IS = e.target.value;
                        } else {
                            compositionData.plan['id√©es directrices'][idIndex]['id√©es secondaires'][isIndex].exemple = e.target.value;
                        }
                    } else if (e.target.closest('.section') && e.target.tagName === 'TEXTAREA') {
                        compositionData.plan['id√©es directrices'][idIndex].ID = e.target.value;
                    }
                }
            });

            // Boutons d'import/export
            importBtn.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            compositionData = data;
                            refreshUI();
                            updateButtonStates();
                        } catch (err) {
                            alert("Erreur lors de l'import du fichier JSON.");
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            });
            exportBtn.addEventListener('click', () => {
                const dataStr = JSON.stringify(compositionData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = 'composition.json';
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            });

            // Raccourcis clavier
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey) {
                    switch (e.key) {
                        case 'e':
                            e.preventDefault();
                            exportBtn.click();
                            break;
                        case 'i':
                            e.preventDefault();
                            importBtn.click();
                            break;
                        case '1':
                            e.preventDefault();
                            if (!step1Btn.disabled) step1Btn.click();
                            break;
                        case '2':
                            e.preventDefault();
                            if (!step2Btn.disabled) step2Btn.click();
                            break;
                        case '3':
                            e.preventDefault();
                            if (!step3Btn.disabled) step3Btn.click();
                            break;
                        case '4':
                            e.preventDefault();
                            if (!step4Btn.disabled) step4Btn.click();
                            break;
                    }
                }
            });

            // Boutons d'√©tapes
            step1Btn.addEventListener('click', () => runStep(1));
            step2Btn.addEventListener('click', () => runStep(2));
            step3Btn.addEventListener('click', () => runStep(3));
            step4Btn.addEventListener('click', () => runStep(4));

            // Bouton magique
            magicBtn.addEventListener('click', async () => {
                magicBtn.disabled = true;
                magicBtn.classList.add('loading');
                try {
                    for (let i = 1; i <= 4; i++) {
                        await runStep(i, true);
                    }
                } catch (err) {
                    console.error("Erreur lors de l'ex√©cution magique:", err);
                } finally {
                    magicBtn.disabled = false;
                    magicBtn.classList.remove('loading');
                }
            });
        }

        // Ex√©cution d'une √©tape
        async function runStep(step, isMagic = false) {
            let button, promptTextarea;
            switch (step) {
                case 1:
                    button = step1Btn;
                    promptTextarea = step1Prompt;
                    break;
                case 2:
                    button = step2Btn;
                    promptTextarea = step2Prompt;
                    break;
                case 3:
                    button = step3Btn;
                    promptTextarea = step3Prompt;
                    break;
                case 4:
                    button = step4Btn;
                    promptTextarea = step4Prompt;
                    break;
            }
            if (!button || button.disabled) return;
            button.disabled = true;
            button.classList.add('loading');
            try {
                // Pr√©paration du prompt
                const prompt = `${basePrompt.value}\n\n${promptTextarea.value}\n\nJSON actuel:\n${JSON.stringify(compositionData, null, 2)}`;
                lastSentDiv.textContent = prompt;
                // Appel API
                const response = await fetch('http://localhost:3000/api/prompt', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt })
                });
                if (!response.ok) {
                    throw new Error(`Erreur HTTP : ${response.status}`);
                }
                const data = await response.json();
                let responseContent = data.choices[0].message.content;
                // Extraction du JSON de la r√©ponse
                let jsonResponse;
                if (responseContent.startsWith('```json')) {
                    responseContent = responseContent.substring(7, responseContent.lastIndexOf('```')).trim();
                }
                jsonResponse = JSON.parse(responseContent);
                // Mise √† jour des donn√©es
                for (const key in jsonResponse) {
                    if (compositionData.hasOwnProperty(key)) {
                        compositionData[key] = jsonResponse[key];
                    }
                }
                lastReceivedDiv.textContent = JSON.stringify(jsonResponse, null, 2);
                refreshUI();
                updateButtonStates();
                if (!isMagic) {
                    button.classList.remove('loading');
                    button.classList.add('done');
                }
            } catch (err) {
                console.error("Erreur lors de l'appel API:", err);
                lastReceivedDiv.textContent = `Erreur: ${err.message}`;
                if (!isMagic) {
                    button.classList.remove('loading');
                }
            } finally {
                if (!isMagic) {
                    button.disabled = false;
                }
            }
        }

        // Rafra√Æchir l'UI √† partir des donn√©es
        function refreshUI() {
            sujetInput.value = compositionData.sujet;
            sujetCadreInput.value = compositionData['sujet cadr√©'];
            accrocheInput.value = compositionData.plan.accroche;
            ideeMaitresseInput.value = compositionData.plan['id√©e ma√Ætresse'];
            ouvertureInput.value = compositionData.plan.ouverture;
            compositionInput.value = compositionData.composition;
            autoResize(sujetInput);
            autoResize(sujetCadreInput);
            autoResize(accrocheInput);
            autoResize(ideeMaitresseInput);
            autoResize(ouvertureInput);
            autoResize(compositionInput);
            renderFaits();
            renderProblematiques();
            renderIdees();
            renderIdeesDirectrices();
        }

        // D√©marrage
        init();
    </script>
</body>
</html>
